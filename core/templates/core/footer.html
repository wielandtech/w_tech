<div class="footer">
    <div class="metrics-container" id="metrics-container">
        <div class="metrics-title">System Metrics</div>
        <div id="metrics-content">
            <div class="metrics-loading">Loading metrics...</div>
        </div>
    </div>
    <h3>VLAN Technology Services LLC 2025</h3>
</div>

<script>
// Fetch and display Netdata metrics
function fetchMetrics() {
    fetch('/api/metrics/')
        .then(response => response.json())
        .then(data => {
            console.log('Metrics response:', data);  // Debug logging
            
            if (data.status === 'unavailable' || data.status === 'error') {
                let errorMsg = 'Metrics temporarily unavailable';
                if (data.error) {
                    errorMsg += ': ' + data.error;
                }
                if (data.errors && data.errors.length > 0) {
                    errorMsg += ' (' + data.errors.join(', ') + ')';
                }
                document.getElementById('metrics-content').innerHTML = 
                    '<div class="metrics-error">' + errorMsg + '</div>';
                return;
            }
            
            let html = '<div class="metrics-grid">';
            
                   // CPU Card (Cluster + Monitoring)
                   if (data.cpu !== null) {
                       const cpuClass = data.cpu.percentage > 50 ? 'critical' : (data.cpu.percentage > 25 ? 'warning' : '');
                       html += `
                           <div class="metric-card">
                               <div class="metric-label">${data.cpu.description}</div>
                               <div class="metric-value">${data.cpu.percentage}%</div>
                               <div class="metric-detail">${data.cpu.total_cores} cores total</div>
                               <div class="metric-bar">
                                   <div class="metric-bar-fill ${cpuClass}" style="width: ${Math.min(data.cpu.percentage, 100)}%"></div>
                               </div>
                           </div>
                       `;
                   }
            
                   // RAM Card (Cluster Memory)
                   if (data.ram !== null) {
                       const ramClass = data.ram.cluster_estimated_percentage > 85 ? 'critical' : (data.ram.cluster_estimated_percentage > 70 ? 'warning' : '');
                       html += `
                           <div class="metric-card">
                               <div class="metric-label">${data.ram.description}</div>
                               <div class="metric-value">${data.ram.cluster_total_gb} GB</div>
                               <div class="metric-detail">~${data.ram.cluster_estimated_used_gb} GB used</div>
                               <div class="metric-bar">
                                   <div class="metric-bar-fill ${ramClass}" style="width: ${Math.min(data.ram.cluster_estimated_percentage, 100)}%"></div>
                               </div>
                           </div>
                       `;
                   }
            
                   // Active Clients Card
                   if (data.network !== null) {
                       html += `
                           <div class="metric-card">
                               <div class="metric-label">${data.network.description}</div>
                               <div class="metric-value">${data.network.total_clients}</div>
                               <div class="metric-detail">${data.network.avg_per_node} per node</div>
                           </div>
                       `;
                   }
            
                   // API Requests Card
                   if (data.disk !== null) {
                       html += `
                           <div class="metric-card">
                               <div class="metric-label">${data.disk.description}</div>
                               <div class="metric-value">${data.disk.total_requests_ps}/s</div>
                               <div class="metric-detail">${data.disk.avg_per_node}/s per node</div>
                           </div>
                       `;
                   }
            
            html += '</div>';
            
            // Add status indicator
            let statusParts = [];
            if (data.nodes_count) {
                const reachable = data.nodes ? data.nodes.filter(n => n.reachable).length : 0;
                statusParts.push(reachable + '/' + data.nodes_count + ' nodes');
            }
            if (data.cache_hit) {
                statusParts.push('cached');
            }
            if (data.errors && data.errors.length > 0) {
                statusParts.push(data.errors.length + ' warnings');
            }
            if (statusParts.length > 0) {
                html += '<div class="metrics-status">' + statusParts.join(' â€¢ ') + '</div>';
            }
            
            document.getElementById('metrics-content').innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching metrics:', error);
            document.getElementById('metrics-content').innerHTML = 
                '<div class="metrics-error">Unable to load metrics</div>';
        });
}

// Initial fetch
fetchMetrics();

// Refresh every 30 seconds
setInterval(fetchMetrics, 30000);
</script>