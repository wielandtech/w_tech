{% extends 'core/base.html' %}
{% load static %}

{% block title %}Contact - WielandTech{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contact.css' %}">
{% endblock %}

{% block content %}
<div class="contact-container">
    <div class="contact-header">
        <h1>Get In Touch</h1>
        <p>Have a question or project in mind? I'd love to hear from you.<br>Send me a message and let's start a conversation.</p>
    </div>

    <div class="contact-form-container">
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" class="contact-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">Name *</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="error-message">{{ form.name.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">Email *</label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="error-message">{{ form.email.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.subject.id_for_label }}">Subject *</label>
                {{ form.subject }}
                {% if form.subject.errors %}
                    <div class="error-message">{{ form.subject.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.message.id_for_label }}">Message *</label>
                {{ form.message }}
                {% if form.message.errors %}
                    <div class="error-message">{{ form.message.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group captcha-group">
                {{ form.captcha }}
                {% if form.captcha.errors %}
                    <div class="error-message">{{ form.captcha.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn">Send Message</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block domready %}
// Contact form ReCaptcha handling
$(document).ready(function() {
    $('.contact-form').on('submit', function(e) {
        var $form = $(this);
        var $submitBtn = $form.find('.submit-btn');

        // Check if ReCaptcha token is already present
        var $tokenInput = $form.find('input[name="g-recaptcha-response"]');
        if ($tokenInput.length === 0 || !$tokenInput.val()) {
            // Token not present, prevent submission and try to get one
            e.preventDefault();

            // Disable submit button to prevent multiple submissions
            $submitBtn.prop('disabled', true).text('Verifying...');

            // Check if grecaptcha is available
            if (typeof grecaptcha !== 'undefined') {
                // Wait a bit for ReCaptcha to initialize, then try to execute
                setTimeout(function() {
                    try {
                        // For ReCaptchaV3, the token should be automatically generated
                        // Let's check if it was created after a short delay
                        var $tokenInput = $form.find('input[name="g-recaptcha-response"]');
                        if ($tokenInput.length > 0 && $tokenInput.val()) {
                            // Token is now present, submit the form
                            $submitBtn.prop('disabled', false).text('Send Message');
                            $form.off('submit'); // Remove this handler
                            $form[0].submit(); // Submit normally
                        } else {
                            // Still no token, show error
                            $submitBtn.prop('disabled', false).text('Send Message');

                            var $messages = $form.closest('.contact-form-container').find('.messages');
                            if ($messages.length === 0) {
                                $messages = $('<div class="messages"></div>');
                                $form.closest('.contact-form-container').prepend($messages);
                            }
                            $messages.html('<div class="alert alert-error">Please wait for verification to complete, then try again.</div>');
                        }
                    } catch (error) {
                        console.error('ReCaptcha error:', error);
                        $submitBtn.prop('disabled', false).text('Send Message');

                        var $messages = $form.closest('.contact-form-container').find('.messages');
                        if ($messages.length === 0) {
                            $messages = $('<div class="messages"></div>');
                            $form.closest('.contact-form-container').prepend($messages);
                        }
                        $messages.html('<div class="alert alert-error">Anti-spam verification failed. Please try again.</div>');
                    }
                }, 1000); // Wait 1 second for ReCaptcha to initialize
            } else {
                // ReCaptcha not loaded
                $submitBtn.prop('disabled', false).text('Send Message');

                var $messages = $form.closest('.contact-form-container').find('.messages');
                if ($messages.length === 0) {
                    $messages = $('<div class="messages"></div>');
                    $form.closest('.contact-form-container').prepend($messages);
                }
                $messages.html('<div class="alert alert-error">Anti-spam verification not available. Please contact us directly.</div>');
            }
        }
        // If token is already present, allow normal submission
    });
});
{% endblock %}
